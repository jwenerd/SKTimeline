{% extends "base/content_base_fullwidth.html" %}

{% block nav_right %}
  <li><a href="/">Home</a></li>
  <li class=active><a href="/dashboard/">Dashboard</a></li>
  <li><a href="/logout/">Logout</a></li>
{% endblock %}

{% block styles %}
  {{super()}}
  <link title="timeline-styles" rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/3.3.16/css/timeline.css">
  <link rel="stylesheet" href="/static/css/emoji.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css">

  <script src="https://cdn.knightlab.com/libs/timeline3/3.3.16/js/timeline.js"></script>
  <script src="/static/js/emoji.js"></script>
{% endblock %}

{% block footer_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
<script>
  jQuery(document).ready(function(){
    var feed_data = {{feed_groups_data|safe}};
    var feed_groups = {{feed_groups|safe}};


    var emoji = new EmojiConvertor(); // force text output mode
    emoji.text_mode = false;
    emoji.include_title = true;
    emoji.use_sheet = false
    emoji.img_set = 'emojione';
    emoji.img_sets.emojione.path = '/static/media/emoji-data/img-emojione-64/';
    $.each(feed_data, function(id, items){
      if ( id.includes('slack-') ){
        $.each(items, function(i, value){
          value.text.text = emoji.replace_colons( value.text.text );
        });
      }
    });
    console.log(feed_data);

    function drawTimeline( groups , search_text ) {
      // groups is the array of which timeline groups to show on this draw of the timeline
      $('#timeline').children().remove();
      window.timeline = false;
      events = filterEvents( groups, search_text );
      if ( events.length ) {
        window.timeline = new TL.Timeline('timeline', {
          events: events,
        });
      } else {
        $('#timeline')
          .removeAttr('class')
          .html( '<p class="container">No events matched your current filter criteria</p>');
      }

    }

    function filterEvents(groups, search_text) {
      var selected_groups_data = $.map(feed_data, function(data, key){
        if ( $.inArray(key, groups) != -1 ) {
          return data;
        }
      });
      if ( search_text ) {
        search_text = $.trim( search_text.toLowerCase() );
        selected_groups_data = $.map(selected_groups_data, function(data, key){
          if ( data.type == 'twitter' ){
            if ( data.tweet_text.toLowerCase().indexOf(search_text) != -1 ) {
              return data;
            }
          } else if ( data.text.text.toLowerCase().indexOf(search_text) != -1 ){
            return data;
          } else if ( data.text.headline && data.text.headline.toLowerCase().indexOf(search_text) != -1 ) {
            return data;
          }

        });
      }
      return selected_groups_data;
    }



    drawTimeline( $.map(feed_groups, function(group){ return group.id }) );

    if ( feed_groups.length > 1 ) {
      $('#timeline-select').select2({
        closeOnSelect: true,
        data: $.map(feed_groups, function(group, i){
          group.selected = true;
          return group;
        }),
        templateResult: function(data, container){
          $(container).attr('data-title', data.text)
          return data.text;
        }
        // todo: see if can make a minimum 1 must always be selected otherwise timeline is blank
      }).on('change', timelineRedrawSelectedGroups)
        .on('select2:unselecting', function(e){
          $('body').addClass('tl-unselecting');
        })
        .on('select2:unselect', function(e){

          setTimeout(function(){
            /* hack to close the select box and it is already hidden via CSS the body.tl-unselecting class */
            $(e.target).select2('close');
            $('body').removeClass('tl-unselecting');
          }, 10);
        });

    } else {
      $('#timeline-select-container').hide();
    }

    function timelineRedrawSelectedGroups(){
      var groups = $('#timeline-select').val(),
        filterText = $.trim( $('#search').val() ),
        current_id = window.timeline.current_id;
      filterText = (filterText != '') ? filterText : false;

      drawTimeline( groups, filterText );
      if (window.timeline.ready){
        window.timeline.goToId(current_id); // go to last selected slide after reiniting
      }
      return true;
    }

    $('#filter-submit').on('click',function(e){
      e.preventDefault();
      timelineRedrawSelectedGroups();

    })

  });

  </script>
{% endblock %}

{% block content_base %}
  <div id="timeline-select-container" class="container">
    <select style="width:100%;" id="timeline-select" multiple="multiple"></select>
  </div>
  <form id="timeline-text-filter" class="container">
    <div class="form-group">
      <label for="search">Search</label>
      <input type="text" class="form-control" id="search" placeholder="Filter timeline items">
      <button type="submit" class="btn btn-default" id="filter-submit">Filter</button>
    </div>

  </form>
  <div id="timeline"></div>
{% endblock %}
